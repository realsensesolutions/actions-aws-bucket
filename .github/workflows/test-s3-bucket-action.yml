name: Test S3 Bucket Action

on:
  workflow_dispatch:
  pull_request:
    paths:
      - '**.tf'
      - 'action.yml'
      - '.github/workflows/**'

jobs:
  test-bucket-creation:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix:
        include:
          # Test default (legacy) naming pattern
          - test_name: legacy-pattern
            bucket_name: test-app
            naming_pattern: default
            bucket_purpose: files
            expected_pattern: "test-app-action-aws-bucket-"
          
          # Test service-provider pattern with files purpose
          - test_name: service-provider-files
            bucket_name: inrush
            naming_pattern: service-provider
            bucket_purpose: files
            expected_pattern: "inrush-files-"
          
          # Test service-provider pattern with assets purpose
          - test_name: service-provider-assets
            bucket_name: ldeng
            naming_pattern: service-provider
            bucket_purpose: assets
            expected_pattern: "ldeng-assets-"
          
          # Test service-provider pattern with backups purpose
          - test_name: service-provider-backups
            bucket_name: test-provider
            naming_pattern: service-provider
            bucket_purpose: backups
            expected_pattern: "test-provider-backups-"

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: test-bucket-${{ matrix.test_name }}-${{ github.run_id }}
          aws-region: us-east-1

      - name: Setup Terraform Backend
        uses: realsensesolutions/actions-aws-backend-setup@main
        with:
          instance: test-bucket-action

      - name: Create S3 Bucket
        id: create-bucket
        timeout-minutes: 5
        uses: ./
        with:
          name: ${{ matrix.bucket_name }}
          naming_pattern: ${{ matrix.naming_pattern }}
          bucket_purpose: ${{ matrix.bucket_purpose }}

      - name: Wait for other buckets to complete
        run: |
          echo "â³ Waiting 30 seconds for other parallel bucket creations to complete..."
          sleep 30

      - name: Verify Bucket Name Pattern
        run: |
          BUCKET_NAME="${{ steps.create-bucket.outputs.name }}"
          EXPECTED_PATTERN="${{ matrix.expected_pattern }}"
          
          echo "ðŸ“¦ Created bucket: $BUCKET_NAME"
          echo "ðŸ” Expected pattern: $EXPECTED_PATTERN"
          
          if [[ "$BUCKET_NAME" == $EXPECTED_PATTERN* ]]; then
            echo "âœ… Bucket name matches expected pattern!"
          else
            echo "âŒ Bucket name does NOT match expected pattern!"
            echo "   Expected to start with: $EXPECTED_PATTERN"
            echo "   Actual bucket name: $BUCKET_NAME"
            exit 1
          fi
          
          # Verify bucket name length (S3 limit is 63 characters)
          BUCKET_LENGTH=${#BUCKET_NAME}
          if [ $BUCKET_LENGTH -gt 63 ]; then
            echo "âŒ Bucket name exceeds 63 character limit!"
            echo "   Length: $BUCKET_LENGTH"
            exit 1
          else
            echo "âœ… Bucket name length is valid: $BUCKET_LENGTH characters"
          fi

      - name: Verify Bucket Exists
        run: |
          BUCKET_NAME="${{ steps.create-bucket.outputs.name }}"
          
          echo "ðŸ” Verifying bucket exists in AWS..."
          if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>&1; then
            echo "âœ… Bucket exists and is accessible!"
          else
            echo "âŒ Bucket does not exist or is not accessible!"
            exit 1
          fi

      - name: Verify Bucket Configuration
        run: |
          BUCKET_NAME="${{ steps.create-bucket.outputs.name }}"
          
          echo "ðŸ” Checking bucket configuration..."
          
          # Check public access block
          PUBLIC_ACCESS=$(aws s3api get-public-access-block --bucket "$BUCKET_NAME" 2>/dev/null || echo "not-configured")
          if [ "$PUBLIC_ACCESS" != "not-configured" ]; then
            echo "âœ… Public access block is configured"
          else
            echo "âš ï¸ Public access block not found (may be default)"
          fi
          
          # Check versioning (should be disabled)
          VERSIONING=$(aws s3api get-bucket-versioning --bucket "$BUCKET_NAME" --query 'Status' --output text 2>/dev/null || echo "Disabled")
          if [ "$VERSIONING" == "Disabled" ] || [ "$VERSIONING" == "None" ]; then
            echo "âœ… Versioning is disabled (as expected)"
          else
            echo "âš ï¸ Versioning status: $VERSIONING"
          fi

      - name: Cleanup Test Bucket
        if: always()
        run: |
          BUCKET_NAME="${{ steps.create-bucket.outputs.name }}"
          
          echo "ðŸ§¹ Cleaning up test bucket: $BUCKET_NAME"
          
          # Delete all objects in the bucket
          aws s3 rm s3://$BUCKET_NAME --recursive 2>/dev/null || true
          
          # Delete the bucket
          aws s3api delete-bucket --bucket "$BUCKET_NAME" 2>/dev/null || true
          
          echo "âœ… Cleanup completed"

  test-backward-compatibility:
    runs-on: ubuntu-latest
    name: Test Backward Compatibility
    timeout-minutes: 5

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: test-backward-compat-${{ github.run_id }}
          aws-region: us-east-1

      - name: Setup Terraform Backend
        uses: realsensesolutions/actions-aws-backend-setup@main
        with:
          instance: test-bucket-action

      - name: Test Default Behavior (No naming_pattern specified)
        id: test-default
        timeout-minutes: 5
        uses: ./
        with:
          name: backward-compat-test
          # naming_pattern not specified - should default to "default"

      - name: Wait for other buckets to complete
        run: |
          echo "â³ Waiting 30 seconds for other parallel bucket creations to complete..."
          sleep 30

      - name: Verify Default Pattern Used
        run: |
          BUCKET_NAME="${{ steps.test-default.outputs.name }}"
          
          echo "ðŸ“¦ Created bucket: $BUCKET_NAME"
          
          if [[ "$BUCKET_NAME" == "backward-compat-test-action-aws-bucket-"* ]]; then
            echo "âœ… Backward compatibility maintained - default pattern used!"
          else
            echo "âŒ Backward compatibility broken!"
            echo "   Expected pattern: backward-compat-test-action-aws-bucket-*"
            echo "   Actual: $BUCKET_NAME"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          BUCKET_NAME="${{ steps.test-default.outputs.name }}"
          aws s3 rm s3://$BUCKET_NAME --recursive 2>/dev/null || true
          aws s3api delete-bucket --bucket "$BUCKET_NAME" 2>/dev/null || true
